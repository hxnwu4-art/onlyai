<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>AI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html,
      body {
        height: 100%;
      }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, #e0f2fe 0, #f1f5f9 40%, #e0e7ff 100%);
        color: #0f172a;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      body.dark {
        background: radial-gradient(circle at top, #020617 0, #020617 40%, #111827 100%);
        color: #e5e7eb;
      }

      :root {
        --chat-font-size: 15px;
      }

      .app-shell {
        width: 100%;
        max-width: 430px;
        height: 90vh;
        border-radius: 32px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.7),
            rgba(255, 255, 255, 0.1)
          );
        backdrop-filter: blur(24px);
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.5);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      body.dark .app-shell {
        background: linear-gradient(
            135deg,
            rgba(15, 23, 42, 0.8),
            rgba(15, 23, 42, 0.3)
          );
        border-color: rgba(148, 163, 184, 0.4);
      }

      .header {
        padding: 16px 16px 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-left span {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        color: #64748b;
      }

      body.dark .header-left span {
        color: #94a3b8;
      }

      .header-left h1 {
        font-size: 20px;
        font-weight: 600;
      }

      .header-right {
        font-size: 11px;
        color: #64748b;
      }

      body.dark .header-right {
        color: #e5e7eb;
      }

      .top-controls {
        padding: 0 16px 12px;
        display: flex;
        justify-content: space-between;
        gap: 8px;
      }

      .mode-switch {
        display: inline-flex;
        padding: 4px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.7);
      }

      body.dark .mode-switch {
        background: rgba(15, 23, 42, 0.8);
        border-color: rgba(148, 163, 184, 0.4);
      }

      .mode-button {
        border: none;
        background: transparent;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        color: #64748b;
        transition: 0.15s all ease;
      }

      body.dark .mode-button {
        color: #e5e7eb;
      }

      .mode-button.active {
        background: #020617;
        color: #f9fafb;
        box-shadow: 0 4px 10px rgba(15, 23, 42, 0.4);
      }

      body.dark .mode-button.active {
        background: #f9fafb;
        color: #020617;
      }

      .font-switch {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(16px);
      }

      body.dark .font-switch {
        background: rgba(15, 23, 42, 0.85);
        border-color: rgba(148, 163, 184, 0.4);
      }

      .font-switch-label {
        font-size: 10px;
        color: #64748b;
      }

      body.dark .font-switch-label {
        color: #e5e7eb;
      }

      .font-button {
        width: 24px;
        height: 24px;
        border-radius: 999px;
        border: none;
        font-size: 11px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        color: #64748b;
      }

      body.dark .font-button {
        color: #e5e7eb;
      }

      .font-button.active {
        background: #020617;
        color: #f9fafb;
      }

      body.dark .font-button.active {
        background: #f9fafb;
        color: #020617;
      }

      .messages {
        flex: 1;
        padding: 0 16px 12px;
        overflow-y: auto;
        scroll-behavior: smooth;
        font-size: var(--chat-font-size);
      }

      .messages::-webkit-scrollbar {
        width: 4px;
      }

      .messages::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.7);
        border-radius: 999px;
      }

      .empty-state {
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 6px;
        text-align: center;
        color: #64748b;
        font-size: 14px;
      }

      body.dark .empty-state {
        color: #94a3b8;
      }

      .empty-tag {
        font-size: 12px;
        letter-spacing: 0.18em;
        text-transform: uppercase;
      }

      .message-row {
        width: 100%;
        display: flex;
        margin-bottom: 8px;
      }

      .message-row.user {
        justify-content: flex-end;
      }

      .message-row.assistant {
        justify-content: flex-start;
      }

      .message-inner {
        display: flex;
        align-items: flex-end;
        gap: 6px;
        max-width: 90%;
      }

      .message-row.user .message-inner {
        flex-direction: row-reverse;
      }

      .bubble {
        max-width: 100%;
        border-radius: 24px;
        padding: 10px 14px;
        line-height: 1.5;
        white-space: pre-wrap;
        border: 1px solid rgba(255, 255, 255, 0.7);
        box-shadow: 0 10px 26px rgba(15, 23, 42, 0.45);
      }

      .bubble.user {
        background: linear-gradient(135deg, #6366f1, #0ea5e9);
        color: #f9fafb;
        box-shadow: 0 12px 30px rgba(56, 189, 248, 0.5);
      }

      .bubble.assistant {
        background: rgba(255, 255, 255, 0.7);
        color: #020617;
      }

      body.dark .bubble.assistant {
        background: rgba(15, 23, 42, 0.8);
        color: #f9fafb;
      }

      .bubble.user.send-anim {
        animation: sendBubble 0.32s cubic-bezier(0.21, 0.9, 0.24, 1.12) both;
        transform-origin: bottom right;
      }

      @keyframes sendBubble {
        0% {
          transform: translate(40px, 18px) scale(0.8);
          opacity: 0;
        }
        55% {
          transform: translate(0, 0) scale(1.06);
          opacity: 1;
        }
        100% {
          transform: translate(0, 0) scale(1);
          opacity: 1;
        }
      }

      .bubble.assistant.recv-anim {
        animation: recvBubble 0.32s cubic-bezier(0.21, 0.9, 0.24, 1.12) both;
        transform-origin: bottom left;
      }

      @keyframes recvBubble {
        0% {
          transform: translate(-40px, 18px) scale(0.8);
          opacity: 0;
        }
        55% {
          transform: translate(0, 0) scale(1.06);
          opacity: 1;
        }
        100% {
          transform: translate(0, 0) scale(1);
          opacity: 1;
        }
      }

      .read-button {
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.8);
        background: rgba(255, 255, 255, 0.7);
        padding: 3px 8px;
        font-size: 11px;
        cursor: pointer;
        backdrop-filter: blur(12px);
        color: #334155;
      }

      body.dark .read-button {
        background: rgba(15, 23, 42, 0.9);
        border-color: rgba(148, 163, 184, 0.5);
        color: #e5e7eb;
      }

      .typing-row {
        display: flex;
        justify-content: flex-start;
        margin-bottom: 10px;
      }

      .typing-bubble {
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.7);
        background: rgba(255, 255, 255, 0.8);
        padding: 8px 10px;
        font-size: 12px;
        color: #334155;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        backdrop-filter: blur(12px);
      }

      body.dark .typing-bubble {
        background: rgba(15, 23, 42, 0.85);
        border-color: rgba(148, 163, 184, 0.4);
        color: #e5e7eb;
      }

      .typing-dots {
        display: flex;
        gap: 4px;
      }

      .typing-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: #64748b;
        animation: bounceDot 0.9s infinite;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.08s;
      }

      .typing-dot:nth-child(3) {
        animation-delay: 0.16s;
      }

      @keyframes bounceDot {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-2px);
        }
      }

      .footer {
        padding: 8px 16px 16px;
        background: linear-gradient(
          to top,
          rgba(255, 255, 255, 0.9),
          rgba(255, 255, 255, 0.1)
        );
        backdrop-filter: blur(24px);
      }

      body.dark .footer {
        background: linear-gradient(
          to top,
          rgba(2, 6, 23, 0.95),
          rgba(15, 23, 42, 0.4)
        );
      }

      .input-row {
        display: flex;
        align-items: flex-end;
        gap: 8px;
      }

      .input-box {
        flex: 1;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.7);
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(16px);
        padding: 6px 12px;
        display: flex;
      }

      body.dark .input-box {
        background: rgba(15, 23, 42, 0.85);
        border-color: rgba(148, 163, 184, 0.4);
      }

      .input-box textarea {
        width: 100%;
        border: none;
        outline: none;
        resize: none;
        background: transparent;
        color: inherit;
        font-size: var(--chat-font-size);
        line-height: 1.4;
      }

      .input-box textarea::placeholder {
        color: #94a3b8;
      }

      body.dark .input-box textarea::placeholder {
        color: #64748b;
      }

      .send-button {
        width: 40px;
        height: 40px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-size: 17px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #020617;
        color: #f9fafb;
        box-shadow: 0 10px 26px rgba(15, 23, 42, 0.7);
      }

      .send-button:disabled {
        background: rgba(148, 163, 184, 0.6);
        color: #64748b;
        cursor: default;
        box-shadow: none;
      }

      body.dark .send-button {
        background: #f9fafb;
        color: #020617;
      }

      .voice-box {
        border-radius: 24px;
        border: 1px solid rgba(255, 255, 255, 0.7);
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(18px);
        padding: 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }

      body.dark .voice-box {
        background: rgba(15, 23, 42, 0.9);
        border-color: rgba(148, 163, 184, 0.4);
      }

      .voice-label {
        font-size: 11px;
        color: #64748b;
      }

      body.dark .voice-label {
        color: #e5e7eb;
      }

      .voice-mic-button {
        position: relative;
        width: 80px;
        height: 80px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.7);
        background: conic-gradient(
          from 180deg,
          #38bdf8,
          #6366f1,
          #a855f7,
          #ec4899,
          #38bdf8
        );
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 18px 40px rgba(79, 70, 229, 0.8);
        overflow: hidden;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      .voice-mic-button-inner {
        width: 56px;
        height: 56px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      body.dark .voice-mic-button-inner {
        background: rgba(15, 23, 42, 0.96);
        border-color: rgba(148, 163, 184, 0.6);
      }

      .mic-icon {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .mic-top {
        width: 14px;
        height: 20px;
        border-radius: 8px;
        background: #020617;
      }

      body.dark .mic-top {
        background: #f9fafb;
      }

      .mic-bar {
        margin-top: 4px;
        width: 24px;
        height: 2px;
        border-radius: 999px;
        background: #020617;
      }

      body.dark .mic-bar {
        background: #f9fafb;
      }

      .mic-stem {
        margin-top: 2px;
        width: 1px;
        height: 12px;
        background: #020617;
      }

      body.dark .mic-stem {
        background: #f9fafb;
      }

      .mic-base {
        margin-top: 2px;
        width: 16px;
        height: 2px;
        border-radius: 999px;
        background: #020617;
      }

      body.dark .mic-base {
        background: #f9fafb;
      }

      .voice-box.recording .voice-mic-button {
        transform: scale(1.06);
        box-shadow: 0 22px 50px rgba(129, 140, 248, 0.95);
      }

      .voice-ring {
        position: absolute;
        inset: -10px;
        border-radius: 999px;
        border: 1px solid rgba(244, 114, 182, 0.7);
        animation: ping 1.3s infinite;
      }

      @keyframes ping {
        0% {
          opacity: 0.9;
          transform: scale(1);
        }
        100% {
          opacity: 0;
          transform: scale(1.3);
        }
      }

      .voice-bars {
        display: flex;
        align-items: flex-end;
        gap: 4px;
        height: 28px;
      }

      .voice-bar {
        width: 6px;
        border-radius: 999px;
        background: rgba(56, 189, 248, 0.9);
        height: 6px;
        opacity: 0.4;
        transition: height 0.3s ease, opacity 0.3s ease;
      }

      body.dark .voice-bar {
        background: rgba(34, 211, 238, 0.9);
      }

      .voice-box.recording .voice-bar {
        animation: voiceBar 0.9s ease-in-out infinite;
        opacity: 1;
      }

      @keyframes voiceBar {
        0%,
        100% {
          height: 5px;
          opacity: 0.4;
        }
        50% {
          height: 24px;
          opacity: 1;
        }
      }

      .voice-bar:nth-child(1) {
        animation-delay: 0s;
      }
      .voice-bar:nth-child(2) {
        animation-delay: 0.06s;
      }
      .voice-bar:nth-child(3) {
        animation-delay: 0.12s;
      }
      .voice-bar:nth-child(4) {
        animation-delay: 0.18s;
      }
      .voice-bar:nth-child(5) {
        animation-delay: 0.24s;
      }
      .voice-bar:nth-child(6) {
        animation-delay: 0.3s;
      }
      .voice-bar:nth-child(7) {
        animation-delay: 0.36s;
      }
      .voice-bar:nth-child(8) {
        animation-delay: 0.42s;
      }

      .voice-hint {
        font-size: 11px;
        color: #94a3b8;
        text-align: center;
      }

      body.dark .voice-hint {
        color: #64748b;
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <header class="header">
        <div class="header-left">
          <span>ai</span>
          <h1>AI</h1>
        </div>
        <div class="header-right" id="themeLabel">ÎùºÏù¥Ìä∏ ¬∑ ÏãúÏä§ÌÖú</div>
      </header>

      <div class="top-controls">
        <div class="mode-switch">
          <button class="mode-button active" data-mode="text">ÌÖçÏä§Ìä∏</button>
          <button class="mode-button" data-mode="image">Ïù¥ÎØ∏ÏßÄ</button>
          <button class="mode-button" data-mode="voice">ÏùåÏÑ±</button>
          <button class="mode-button" data-mode="history">Í∏∞Î°ù</button>
        </div>

        <div class="font-switch">
          <span class="font-switch-label">Í∏ÄÏî®</span>
          <button class="font-button active" data-font="sm">S</button>
          <button class="font-button" data-font="md">M</button>
          <button class="font-button" data-font="lg">L</button>
        </div>
      </div>

      <main class="messages" id="messages">
        <div class="empty-state" id="emptyState">
          <div class="empty-tag">ready</div>
          <div>
            ÏïÑÎûòÏóêÏÑú Î™®ÎìúÎ•º ÏÑ†ÌÉùÌïòÍ≥†<br />
            Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÍ±∞ÎÇò ÎßêÌï¥ Î≥¥ÏÑ∏Ïöî.
          </div>
        </div>
      </main>

      <footer class="footer">
        <div class="input-row" id="textFooter">
          <div class="input-box">
            <textarea
              id="inputBox"
              rows="1"
              placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî‚Ä¶"
            ></textarea>
          </div>
          <button class="send-button" id="sendButton" disabled>‚Üë</button>
        </div>

        <div class="voice-box" id="voiceFooter" style="display: none">
          <div class="voice-label">
            ÏùåÏÑ± Î™®Îìú ¬∑ ÎàåÎü¨ÏÑú ÏãúÏûë / Îã§Ïãú ÎàåÎü¨ÏÑú Ï¢ÖÎ£å
          </div>

          <button class="voice-mic-button" id="micButton">
            <div class="voice-mic-button-inner">
              <div class="mic-icon">
                <div class="mic-top"></div>
                <div class="mic-bar"></div>
                <div class="mic-stem"></div>
                <div class="mic-base"></div>
              </div>
            </div>
            <div class="voice-ring" id="voiceRing" style="display: none"></div>
          </button>

          <div class="voice-bars">
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
          </div>

          <div class="voice-hint">
            (ÌòÑÏû¨Îäî UIÎßå ÎèôÏûë Ï§ë ¬∑ ÎÇòÏ§ëÏóê Ïã§Ï†ú ÏùåÏÑ±/STT API Ïó∞Í≤∞ Í∞ÄÎä•)
          </div>
        </div>
      </footer>
    </div>

    <script>
    // AIÍ∞Ä Î≥¥ÎÇ∏ ÌÖçÏä§Ìä∏ÏóêÏÑú Ïù¥ÏÉÅÌïú Î¨∏Ïûê(ÌïúÏûê/ÏùºÎ≥∏Ïñ¥ Îì±) ÎÇ†Î¶¨Í∏∞
    function sanitizeAIText(text) {
      if (!text) return text;

      return text.replace(
         /[^\uAC00-\uD7A3\u1100-\u11FF\u3130-\u318F0-9A-Za-z\s.,!?'"()~\-:;‚Ä¶¬∑]/g,
         ""
      );
    }
      // ===== ÏÉÅÌÉú & Ï†ÄÏû• Í¥ÄÎ†® =====
      let currentMode = "text"; // text | image | voice | history
      let isRecording = false;
      let isLoading = false;

      let conversations = JSON.parse(
        localStorage.getItem("ai_conversations") || "[]"
      );
      let currentConversationId = null;
      let messages = [];

      const body = document.body;
      const messagesEl = document.getElementById("messages");
      const emptyStateEl = document.getElementById("emptyState");
      const inputBox = document.getElementById("inputBox");
      const sendButton = document.getElementById("sendButton");
      const textFooter = document.getElementById("textFooter");
      const voiceFooter = document.getElementById("voiceFooter");
      const micButton = document.getElementById("micButton");
      const voiceRing = document.getElementById("voiceRing");
      const themeLabel = document.getElementById("themeLabel");

      function saveConversations() {
        localStorage.setItem(
          "ai_conversations",
          JSON.stringify(conversations)
        );
      }

      function getCurrentConversation() {
        return conversations.find((c) => c.id === currentConversationId) || null;
      }

      function startNewConversation(firstText) {
        const id = crypto.randomUUID();
        const titleBase = firstText || "ÏÉà ÎåÄÌôî";
        const title =
          titleBase.length > 20 ? titleBase.slice(0, 20) + "‚Ä¶" : titleBase;
        const conv = {
          id,
          title,
          createdAt: new Date().toISOString(),
          messages: [],
        };
        conversations.push(conv);
        currentConversationId = id;
        messages = conv.messages;
        saveConversations();
      }

      // ===== ÌÖåÎßà & Í∏ÄÏî® =====
      function setupTheme() {
        if (!window.matchMedia) return;
        const media = window.matchMedia("(prefers-color-scheme: dark)");
        function apply(e) {
          const dark = e ? e.matches : media.matches;
          if (dark) {
            body.classList.add("dark");
            themeLabel.textContent = "Îã§ÌÅ¨ ¬∑ ÏãúÏä§ÌÖú";
          } else {
            body.classList.remove("dark");
            themeLabel.textContent = "ÎùºÏù¥Ìä∏ ¬∑ ÏãúÏä§ÌÖú";
          }
        }
        apply({ matches: media.matches });
        media.addEventListener("change", apply);
      }
      setupTheme();

      const fontButtons = document.querySelectorAll(".font-button");
      fontButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          fontButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const size = btn.dataset.font;
          document.documentElement.style.setProperty(
            "--chat-font-size",
            size === "sm" ? "13px" : size === "md" ? "15px" : "17px"
          );
        });
      });

      // ===== Î™®Îìú Ï†ÑÌôò =====
      const modeButtons = document.querySelectorAll(".mode-button");
      modeButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          modeButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          setMode(btn.dataset.mode);
        });
      });

      function setMode(mode) {
        currentMode = mode;

        if (mode === "voice") {
          textFooter.style.display = "none";
          voiceFooter.style.display = "flex";
          renderMessages();
          return;
        }

        if (mode === "history") {
          textFooter.style.display = "none";
          voiceFooter.style.display = "none";
          renderHistoryList();
          return;
        }

        // text / image
        voiceFooter.style.display = "none";
        textFooter.style.display = "flex";
        inputBox.placeholder =
          mode === "text"
            ? "Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî‚Ä¶"
            : "ÏÉùÏÑ±Ìï† Ïù¥ÎØ∏ÏßÄÎ•º ÏÑ§Î™ÖÌï¥ Ï£ºÏÑ∏Ïöî‚Ä¶";
        renderMessages();
      }

      // ===== Î©îÏãúÏßÄ Î†åÎçîÎßÅ =====
      function renderMessages() {
        messagesEl.innerHTML = "";

        if (messages.length === 0 && !isLoading) {
          emptyStateEl.style.display = "flex";
          messagesEl.appendChild(emptyStateEl);
          return;
        }

        emptyStateEl.style.display = "none";

        messages.forEach((msg) => {
          const row = document.createElement("div");
          row.className = "message-row " + msg.role;

          const inner = document.createElement("div");
          inner.className =
            "message-inner" + (msg.role === "user" ? " user-inner" : "");

          const bubble = document.createElement("div");
          bubble.className = "bubble " + msg.role;
          bubble.textContent = msg.content;

          inner.appendChild(bubble);

          if (msg.role === "assistant") {
            const readBtn = document.createElement("button");
            readBtn.className = "read-button";
            readBtn.textContent = "ÏùΩÍ∏∞";
            readBtn.addEventListener("click", () => speakText(msg.content));
            inner.appendChild(readBtn);
          }

          const delBtn = document.createElement("button");
          delBtn.className = "read-button";
          delBtn.textContent = "ÏÇ≠Ï†ú";
          delBtn.addEventListener("click", () => deleteMessage(msg.id));
          inner.appendChild(delBtn);

          row.appendChild(inner);
          messagesEl.appendChild(row);
        });

        if (isLoading) {
          const typingRow = document.createElement("div");
          typingRow.className = "typing-row";
          typingRow.innerHTML = `
            <div class="typing-bubble">
              <span>(Ï±ÑÌåÖÏùÑ Ï†ÅÎäî Ï§ëÏûÖÎãàÎã§‚Ä¶)</span>
              <span class="typing-dots">
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
              </span>
            </div>
          `;
          messagesEl.appendChild(typingRow);
        }

        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      // ===== Í∏∞Î°ù Î†åÎçîÎßÅ =====
      function renderHistoryList() {
        messagesEl.innerHTML = "";
        emptyStateEl.style.display = "none";

        const wrapper = document.createElement("div");
        wrapper.style.display = "flex";
        wrapper.style.flexDirection = "column";
        wrapper.style.gap = "8px";

        const header = document.createElement("div");
        header.style.display = "flex";
        header.style.justifyContent = "space-between";
        header.style.alignItems = "center";
        header.style.marginBottom = "8px";

        const title = document.createElement("div");
        title.textContent = "ÎåÄÌôî Í∏∞Î°ù";
        title.style.fontSize = "14px";
        title.style.fontWeight = "600";

        header.appendChild(title);

        if (conversations.length > 0) {
          const clearBtn = document.createElement("button");
          clearBtn.textContent = "Î™®Îëê ÏßÄÏö∞Í∏∞";
          clearBtn.className = "read-button";
          clearBtn.addEventListener("click", clearAllConversations);
          header.appendChild(clearBtn);
        }

        wrapper.appendChild(header);

        if (conversations.length === 0) {
          const empty = document.createElement("div");
          empty.textContent = "Ï†ÄÏû•Îêú ÎåÄÌôîÍ∞Ä ÏóÜÏäµÎãàÎã§.";
          empty.style.fontSize = "13px";
          empty.style.color = "#64748b";
          wrapper.appendChild(empty);
        } else {
          const sorted = conversations
            .slice()
            .sort(
              (a, b) =>
                new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
            );
          sorted.forEach((conv) => {
            const item = document.createElement("button");
            item.style.width = "100%";
            item.style.textAlign = "left";
            item.style.border = "none";
            item.style.borderRadius = "16px";
            item.style.padding = "10px 12px";
            item.style.cursor = "pointer";
            item.style.marginBottom = "4px";
            item.style.background = "rgba(255,255,255,0.7)";
            item.style.backdropFilter = "blur(12px)";
            item.style.border = "1px solid rgba(255,255,255,0.7)";

            const titleEl = document.createElement("div");
            titleEl.textContent = conv.title || "Ï†úÎ™© ÏóÜÏùå";
            titleEl.style.fontSize = "13px";
            titleEl.style.fontWeight = "500";

            const metaEl = document.createElement("div");
            metaEl.style.fontSize = "11px";
            metaEl.style.color = "#64748b";
            const d = new Date(conv.createdAt);
            const dateStr = `${d.getFullYear()}.${String(
              d.getMonth() + 1
            ).padStart(2, "0")}.${String(d.getDate()).padStart(2, "0")}`;
            const countStr = `${conv.messages.length}Í∞ú Î©îÏãúÏßÄ`;
            metaEl.textContent = `${dateStr} ¬∑ ${countStr}`;

            item.appendChild(titleEl);
            item.appendChild(metaEl);

            item.addEventListener("click", () => {
              loadConversation(conv.id);
            });

            wrapper.appendChild(item);
          });
        }

        messagesEl.appendChild(wrapper);
      }

      // ===== ÏÇ≠Ï†ú Í∏∞Îä• =====
      function deleteMessage(messageId) {
        if (!currentConversationId) return;
        const conv = getCurrentConversation();
        if (!conv) return;
        conv.messages = conv.messages.filter((m) => m.id !== messageId);
        messages = conv.messages;
        saveConversations();
        renderMessages();
      }

      function clearAllConversations() {
        if (!confirm("Î™®Îì† ÎåÄÌôî Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌï†ÍπåÏöî?")) return;
        conversations = [];
        currentConversationId = null;
        messages = [];
        saveConversations();
        renderHistoryList();
      }

      function loadConversation(convId) {
        const conv = conversations.find((c) => c.id === convId);
        if (!conv) return;
        currentConversationId = convId;
        messages = conv.messages;
        // ÌÖçÏä§Ìä∏ Î™®ÎìúÎ°ú ÎèåÏïÑÍ∞ÄÎ©¥ÏÑú ÎåÄÌôî Î≥¥Ïó¨Ï£ºÍ∏∞
        modeButtons.forEach((b) =>
          b.dataset.mode === "text"
            ? b.classList.add("active")
            : b.classList.remove("active")
        );
        setMode("text");
      }

      // ===== TTS =====
      function speakText(text) {
        const synth = window.speechSynthesis;
        if (!synth) return;
        synth.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "ko-KR";
        synth.speak(u);
      }

      // ===== Î©îÏãúÏßÄ Ï†ÑÏÜ° + AI Ìò∏Ï∂ú =====
      async function sendMessage() {
        const text = inputBox.value.trim();
        if (!text || isLoading) return;

        if (!currentConversationId) {
          startNewConversation(text);
        }

        const conv = getCurrentConversation();
        if (!conv) return;

        const userMsg = {
          id: crypto.randomUUID(),
          role: "user",
          content: text,
          type: currentMode,
          createdAt: new Date().toISOString(),
        };

        conv.messages.push(userMsg);
        messages = conv.messages;
        saveConversations();

        inputBox.value = "";
        updateSendDisabled();
        isLoading = true;
        renderMessages();
        applySendAnimationToLastUserBubble();

        try {
          const res = await fetch("/api/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: text,
              mode: currentMode,
            }),
          });

          if (!res.ok) {
            throw new Error("API ÏöîÏ≤≠ Ïã§Ìå®");
          }

          const data = await res.json();

// üîπ Ïó¨Í∏∞ÏÑú Ìïú Î≤à Ï†ïÎ¶¨
         let aiText = data.answer || "AI ÏùëÎãµÏùÑ Í∞ÄÏ†∏Ïò§ÏßÄ Î™ªÌñàÏñ¥.";
         aiText = sanitizeAIText(aiText);

         const aiMsg = {
           id: crypto.randomUUID(),
           role: "assistant",
           content: aiText,
           type: currentMode,
           createdAt: new Date().toISOString(),
         };
         conv.messages.push(aiMsg);
         messages = conv.messages;
         saveConversations();
        } catch (e) {
          console.error(e);
          const aiMsg = {
            id: crypto.randomUUID(),
            role: "assistant",
            content: "AI ÏÑúÎ≤Ñ ÏöîÏ≤≠ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏñ¥.",
            type: currentMode,
            createdAt: new Date().toISOString(),
          };
          conv.messages.push(aiMsg);
          messages = conv.messages;
          saveConversations();
        } finally {
          isLoading = false;
          renderMessages();
          applyReceiveAnimationToLastAssistantBubble();
        }
      }

      const sendButtonEl = document.getElementById("sendButton");
      sendButtonEl.addEventListener("click", sendMessage);
      inputBox.addEventListener("input", updateSendDisabled);
      inputBox.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      function updateSendDisabled() {
        sendButton.disabled = !inputBox.value.trim() || isLoading;
      }

      function applySendAnimationToLastUserBubble() {
        const userBubbles = messagesEl.querySelectorAll(
          ".message-row.user .bubble.user"
        );
        if (!userBubbles.length) return;
        const last = userBubbles[userBubbles.length - 1];
        last.classList.add("send-anim");
        last.addEventListener(
          "animationend",
          () => last.classList.remove("send-anim"),
          { once: true }
        );
      }

      function applyReceiveAnimationToLastAssistantBubble() {
        const aiBubbles = messagesEl.querySelectorAll(
          ".message-row.assistant .bubble.assistant"
        );
        if (!aiBubbles.length) return;
        const last = aiBubbles[aiBubbles.length - 1];
        last.classList.add("recv-anim");
        last.addEventListener(
          "animationend",
          () => last.classList.remove("recv-anim"),
          { once: true }
        );
      }

      // ===== ÏùåÏÑ± UI =====
      function setRecording(rec) {
        isRecording = rec;
        if (isRecording) {
          voiceFooter.classList.add("recording");
          voiceRing.style.display = "block";
        } else {
          voiceFooter.classList.remove("recording");
          voiceRing.style.display = "none";
        }
      }

      micButton.addEventListener("click", () => {
        setRecording(!isRecording);
      });

      // Ï¥àÍ∏∞: ÌÖçÏä§Ìä∏ Î™®Îìú, ÌòÑÏû¨ ÎåÄÌôî ÏóÜÏùå, ÌôîÎ©¥ÏùÄ Îπà ÏÉÅÌÉú
      renderMessages();
    </script>
  </body>
</html>